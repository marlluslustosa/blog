name: Ranking featured posts

on:
  push:
    branches: [ master ]

  schedule:
    # At 07:00 (every day)
    - cron: '0 7 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      newfileranking: ${{ steps.ranking.outputs.NEWFILERANKING }}
    steps:
    - uses: actions/checkout@v2
      with:
        persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
        fetch-depth: 0 # otherwise, you will failed to push refs to dest repo
    - name: Create local changes
      id: ranking
      run: |
        bash export_goat.sh ${{ secrets.TOKEN_GOAT }} ${{ secrets.API_URL_GOAT }} > export.txt
        rm -rf ranking_posts_old
        cp ranking_posts ranking_posts_old
        bash edit_ranking.sh
        diff ranking_posts ranking_posts_old
        #test - compare two files byte by byte
        if cmp -s ranking_posts ranking_posts_old ; then
          echo '::set-output name=NEWFILERANKING::false'
        else
          echo '::set-output name=NEWFILERANKING::true'
        fi
        rm -rf ranking_posts_old
        rm -rf export.txt

    - name: Upload ranking_posts
      uses: actions/upload-artifact@v2
      with:
        name: rankingposts
        path: ranking_posts

    - name: Commit files
      id: commit
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add -A
        git diff-index --quiet HEAD || git commit -m "edit ranking featured posts"

    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}

#    - name: SendGrid Action
#      uses: mmichailidis/sendgrid-mail-action@v1.0
#      with:
#        sendgrid-token: ${{ secrets.SENDGRID_API_KEY }}
#        mail: marlluslustosa@gmail.com #email de destino
##        #from definido no sendgrid - https://sendgrid.com/docs/API_Reference/SMTP_API/integrating_with_the_smtp_api.html
#        from: lulusendgrid@riseup.net
#        subject: Artigos em destaque - Lulu space
#        text: Aqui é um exemplo de notificação de arquivos de destaque por email!
#      #if files not equals then
#      if: steps.ranking.outputs.NEWFILERANKING == 'true'
  mail:
    runs-on: ubuntu-latest
    steps:
    #- name: SendGrid Action
    - uses: actions/download-artifact@v2
      with:
        name: rankingposts

    - uses: mmichailidis/sendgrid-mail-action@v1.0
      with:
        sendgrid-token: ${{ secrets.SENDGRID_API_KEY }}
        mail: marlluslustosa@gmail.com #email de destino
        #from definido no sendgrid - https://sendgrid.com/docs/API_Reference/SMTP_API/integrating_with_the_smtp_api.html
        from: lulusendgrid@riseup.net
        subject: Artigos em destaque - Lulu space
        text: Aqui é um exemplo de notificação de arquivos de destaque por email!
      #if files not equals then
      if: needs.build.outputs.newfileranking == 'true'
